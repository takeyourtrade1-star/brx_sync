CREATE TYPE sync_status_enum AS ENUM ('idle', 'initial_sync', 'active', 'error');

CREATE TABLE user_sync_settings (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    cardtrader_token_encrypted TEXT NOT NULL,  -- Token criptato con Fernet
    webhook_secret VARCHAR(255),  -- shared_secret da CardTrader /info
    sync_status sync_status_enum NOT NULL DEFAULT 'idle',
    last_sync_at TIMESTAMP WITH TIME ZONE,
    last_error TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);



CREATE TABLE user_inventory_items (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    blueprint_id INTEGER NOT NULL,  -- CardTrader blueprint_id
    quantity INTEGER NOT NULL DEFAULT 0,
    price_cents INTEGER NOT NULL,  -- Prezzo in centesimi
    properties JSONB,  -- {condition, mtg_foil, mtg_language, signed, altered, ...}
    external_stock_id VARCHAR(255),  -- CardTrader product.id per aggiornamenti mirati
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, blueprint_id, external_stock_id)
);

CREATE INDEX idx_inventory_user_id ON user_inventory_items(user_id);
CREATE INDEX idx_inventory_blueprint_id ON user_inventory_items(blueprint_id);
CREATE INDEX idx_inventory_external_stock_id ON user_inventory_items(external_stock_id);
CREATE INDEX idx_inventory_updated_at ON user_inventory_items(updated_at);



CREATE TABLE sync_operations (
    id BIGSERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    operation_id VARCHAR(255) NOT NULL UNIQUE,  -- UUID per idempotenza
    operation_type VARCHAR(50) NOT NULL,  -- 'bulk_sync', 'update', 'webhook'
    status VARCHAR(50) NOT NULL,  -- 'pending', 'completed', 'failed'
    metadata JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP WITH TIME ZONE
);

CREATE INDEX idx_sync_ops_user_id ON sync_operations(user_id);
CREATE INDEX idx_sync_ops_operation_id ON sync_operations(operation_id);
